<?php

/**
 * Implements hook_allow_domain()
 * 
 * We restrict access to .scratchpads.eu and taxon.name
 */
function hosting_scratchpads_allow_domain($url, $params){
  global $user;
  if($user->uid == 0 && (substr($url, -11) == '.taxon.name' || substr($url, -15) == '.scratchpads.eu')){return FALSE;}
  return TRUE;
}

/**
 * Implements hook_block_info()
 */
function hosting_scratchpads_block_info(){
  return array(
    'logo' => array(
      'info' => t('Scratchpads logo'),
      'cache' => DRUPAL_CACHE_GLOBAL,
      'status' => 1,
      'region' => 'logo'
    ),
    'instructions' => array(
      'info' => t('Scratchpads signup instructions'),
      'cache' => DRUPAL_CACHE_GLOBAL,
      'status' => 1,
      'region' => 'sidebar_first'
    ),
    'menu' => array(
      'info' => t('Scratchpads menu links'),
      'cache' => DRUPAL_CACHE_GLOBAL,
      'status' => 1,
      'region' => 'menu'
    )
  );
}

/**
 * Implements hook_block_view()
 */
function hosting_scratchpads_block_view($delta = 'logo'){
  switch($delta){
    case 'logo':
      return array(
        'subject' => '',
        'content' => '<div><a href="/"><img src="http://scratchpads.eu/sites/all/themes/scratchpads_eu/images/logo-green.png"/></a></div>'
      );
    case 'instructions':
      return array(
        'subject' => '',
        'content' => '<p>Signing up for a Scratchpad is free, quick and simple! No knowledge of website creation is required and your site can cover any aspect of natural history (a taxonomic group, a geographical area, club or society, journal, etc).</p>
<p>Sites can focus on specific taxonomic groups, or the biodiversity of a biogeographic region, or indeed any aspect of natural history. Scratchpads are also suitable for societies or for managing and presenting projects. Key features of Scratchpads (see also Scratchpads feature list) include: tools to manage biological classifications, bibliography management, media (images, video and audio), rich taxon pages (with structured descriptions, specimen records, and distribution data), and character matrices.</p>
<p>Scratchpads support various ways of communicating with site members and visitors such as blogs, forums, newsletters and a commenting system.</p>'
      );
    case 'menu':
      return array(
        'subject' => '',
        'content' => '<ul class="menu"><li class="first leaf has-children active menu-mlid-487"><a href="http://scratchpads.eu/" id="menu-item-home" class="active">Home</a></li>
<li class="leaf has-children menu-mlid-400"><a href="http://scratchpads.eu/news" id="menu-item-news">News</a></li>
<li class="leaf has-children menu-mlid-399"><a href="http://scratchpads.eu/explore" id="menu-item-explore">Explore</a></li>
<li class="leaf has-children menu-mlid-624"><a href="http://scratchpads.eu/support" id="menu-item-support">Support</a></li>
<li class="leaf has-children menu-mlid-406"><a href="http://scratchpads.eu/develop" id="menu-item-develop">Develop</a></li>
<li class="last leaf has-children menu-mlid-407"><a href="http://scratchpads.eu/about" id="menu-item-about">About us</a></li>
</ul>'
      );
  }
}

/**
 * Implements hook_node_insert()
 */
function hosting_scratchpads_node_insert($node){
  static $previous_node = FALSE;
  if(!$previous_node){
    $previous_node = $node;
  }
  if($node->type == 'site'){
    if($node->uid == 0){
      // We've failed to save the user associated with the client, which
      // suggests that a user with the same email address already exists. We
      // load that client and swap.
      $query = db_select('node', 'n');
      $query->innerJoin('users', 'u', 'u.uid = n.uid');
      $query->condition('n.type', 'client')->condition('u.mail', $node->email);
      $query->fields('n', array(
        'nid'
      ));
      $query->fields('u', array(
        'uid'
      ));
      $result = $query->execute()->fetch();
      // Delete the extra client that we do not require.
      node_delete($node->client);
      // Update this site node and the existing client node to point to the
      // existing user.
      db_update('node')->condition('nid', array(
        $node->nid,
        $result->nid
      ))->fields(array(
        'uid' => $result->uid
      ))->execute();
      db_update('node_revision')->condition('nid', array(
        $node->nid,
        $result->nid
      ))->fields(array(
        'uid' => $result->uid
      ))->execute();
      // Update the link to the client node.
      db_update('hosting_site')->condition('nid', $node->nid)->fields(array(
        'client' => $result->nid
      ))->execute();
    }
    db_insert('hosting_scratchpads')->fields(array(
      'nid' => $node->nid,
      'client_title' => $previous_node->client_title,
      'client_name' => $previous_node->title,
      'client_email' => $previous_node->email,
      'client_institution' => $previous_node->client_institution,
      'client_country' => $previous_node->client_country,
      'site_title' => $node->site_title,
      'site_domain' => $node->title,
      'site_taxonomic_scope' => $node->site_taxonomic_scope,
      'site_comments' => $node->site_comments
    ))->execute();
  }
}

/**
 * Implements hook_node_load()
 */
function hosting_scratchpads_node_load($nodes, $types){
  // Decide whether any of $types are relevant to our purposes.
  if(in_array('site', $types)){
    // Gather our extra data for each of these nodes.
    $results = db_select('hosting_scratchpads', 'h')->fields('h')->condition('nid', array_keys($nodes))->execute();
    // Add our extra data to the node objects.
    foreach($results as $record){
      $nid = $record->nid;
      unset($record->nid);
      foreach($record as $key => $column){
        $nodes[$nid]->$key = $column;
      }
    }
  }
}

/**
 * Tweak the view of the site node.
 */
function hosting_scratchpads_node_view_alter(&$build){
  $weight = 100;
  if($build['#node']->type == 'site'){
    foreach(array(
      'client_title',
      'client_name',
      'client_email',
      'client_institution',
      'client_country',
      'site_title',
      'site_domain',
      'site_taxonomic_scope',
      'site_comments'
    ) as $key){
      if(isset($build['#node']->$key)){
        $name = explode('_', $key);
        array_shift($name);
        $name = t(ucfirst(implode(' ', $name)));
        $build['info'][$key] = array(
          '#type' => 'item',
          '#title' => $name,
          '#markup' => $build['#node']->$key . '&nbsp;',
          '#weight' => $weight++
        );
      }
    }
  }
}

/**
 * Implements hook_form_alter()
 */
function hosting_scratchpads_form_alter(&$form, &$form_state, $form_id){
  global $user;
  if($user->uid){
    drupal_goto('hosting/sites');
  }
  if(arg(1) == 'signup'){
    switch($form_id){
      case 'site_node_form':
        // Set the profile
        foreach($form['profile']['#options'] as $key => $value){
          if($value == 'Scratchpad 2 <em>(scratchpad_2)</em>'){
            $form['profile'] = array(
              '#type' => 'value',
              '#value' => $key
            );
            break;
          }
        }
        // Set the platform
        $platform = 0;
        foreach($form['platform']['#options'] as $key => $value){
          // We default to the scratchpads-master platform, in case we do not
          // have a stable platform
          if($key > $platform && ($value == 'scratchpads-master' || preg_match('/scratchpads-2.[0-9]*.[0-9]*/', $value))){
            $platform = $key;
          }
        }
        if($platform){
          $form['platform'] = array(
            '#type' => 'value',
            '#value' => $platform
          );
        }
        $form['site_language'] = array(
          '#type' => 'value',
          '#value' => 'en'
        );
        // Get the DB server with the least number of sites
        //SELECT s.db_server FROM hosting_db_server d INNER JOIN node n ON d.nid = n.nid INNER JOIN hosting_site s ON s.db_server = n.nid WHERE n.title LIKE 'sp%' GROUP BY s.db_server ORDER BY COUNT(*) ASC LIMIT 1;
        // FROM  ORDER BY COUNT(*) ASC LIMIT 1;
        $query = db_select('hosting_db_server', 'd');
        $query->innerJoin('node', 'n', 'd.nid = n.nid');
        $query->innerJoin('hosting_site', 's', 's.db_server = n.nid');
        $query->condition('n.title', 'sp%', 'LIKE');
        $query->fields('s', array(
          'db_server'
        ));
        $query->groupBy('s.db_server');
        $alias = $query->addExpression('COUNT(*)', 'order_by_count');
        $query->orderBy($alias);
        $results = $query->execute()->fetch();
        if($results->db_server && isset($form['db_server']['#options'][$results->db_server])){
          $form['db_server'] = array(
            '#type' => 'value',
            '#value' => $results->db_server
          );
        }
        $form['form_title'] = array(
          '#weight' => -1000,
          '#markup' => '<h2>' . t('About your site') . '</h2>'
        );
        $form['title']['#attributes']['placeholder'] = 'mus-musculus';
        $form['title']['#description'] = '<h3>Your domain name should be:</h3><ul><li><em>Short</em>. You can choose up to 34 characters, but short names and single words are easier to remember. We recommend no more than 20 characters.</li><li><em>Simple</em>. The subdomain name should be your website\'s name.</li><li><em>Legal</em>. Spaces and special characters are not allowed. Remember also that domain names are NOT case sensitive.</li><li><em>Relevant</em>. For a taxonomic site, enter the highest taxon you will be working on, e.g. "diptera" or "britishdiptera".  For a society site, enter the society\'s acronym, e.g. "bogsoc" or "windsoc".</li></ul><h3>Using your own domain</h3><p>Users are more than welcome to purchase their own domain name for use with a Scratchpad.  All that is required is that the domain name is pointed at our server quartz.nhm.ac.uk which has the IP address 157.140.2.32.  If using your own domain name, the domain purchase should be completed before the Scratchpad application.</p><p>If you would like to use your own domain name, then enter the full domain name (without "http://").</p>';
        $form['site_title'] = array(
          '#required' => TRUE,
          '#type' => 'textfield',
          '#title' => t('Site title'),
          '#weight' => -11,
          '#description' => 'The site title will appear in the header section of your Scratchpad by default but can be removed later.',
          '#attributes' => array(
            'placeholder' => 'My Mice!'
          )
        );
        $form['site_taxonomic_scope'] = array(
          '#required' => TRUE,
          '#type' => 'textfield',
          '#title' => t('Taxonomic scope'),
          '#weight' => -9,
          '#description' => t('The taxonomic group which best describes what taxa will be featured on your site. e.g. Insecta, Aves, Phthiraptera, Dragons'),
          '#attributes' => array(
            'placeholder' => 'Mus musculus'
          )
        );
        $form['site_comments'] = array(
          '#type' => 'textarea',
          '#title' => t('Comments'),
          '#weight' => -8
        );
        $form['#prefix'] = '<div class="scratchpads-hosting-site-form">';
        $form['#suffix'] = '</div>';
        break;
      case 'client_node_form':
        $form['email']['#description'] = 'Your email address. This must be a valid email address, as your password will be sent to it';
        $form['#prefix'] = '<div class="scratchpads-hosting-client-form" >';
        $form['#suffix'] = '</div>';
        $form['title']['#title'] = t('Full name');
        $form['title']['#weight'] = -10;
        $form['client_title'] = array(
          '#title' => t('Title'),
          '#required' => TRUE,
          '#type' => 'select',
          '#weight' => -11,
          '#options' => array(
            'Mr' => 'Mr',
            'Mrs' => 'Mrs',
            'Miss' => 'Miss',
            'Ms' => 'Ms',
            'Dr' => 'Dr',
            'Prof.' => 'Prof',
            'Other' => 'Other'
          )
        );
        $form['client_institution'] = array(
          '#title' => t('Institution'),
          '#description' => t('The institution with which you are most closely associated. If retired or amateur, please insert "N/A"'),
          '#type' => 'textfield',
          '#required' => TRUE
        );
        $form['client_country'] = array(
          '#title' => t('Country'),
          '#description' => t('The country that you are based in.'),
          '#type' => 'select',
          '#required' => TRUE,
          '#options' => array(
            NULL => '-- Select --',
            'AF' => 'Afghanistan',
            'AX' => 'Aland Islands',
            'AL' => 'Albania',
            'DZ' => 'Algeria',
            'AS' => 'American Samoa',
            'AD' => 'Andorra',
            'AO' => 'Angola',
            'AI' => 'Anguilla',
            'AQ' => 'Antarctica',
            'AG' => 'Antigua and Barbuda',
            'AR' => 'Argentina',
            'AM' => 'Armenia',
            'AW' => 'Aruba',
            'AU' => 'Australia',
            'AT' => 'Austria',
            'AZ' => 'Azerbaijan',
            'BS' => 'Bahamas',
            'BH' => 'Bahrain',
            'BD' => 'Bangladesh',
            'BB' => 'Barbados',
            'BY' => 'Belarus',
            'BE' => 'Belgium',
            'BZ' => 'Belize',
            'BJ' => 'Benin',
            'BM' => 'Bermuda',
            'BT' => 'Bhutan',
            'BO' => 'Bolivia',
            'BQ' => 'Bonaire, Sint Eustatius and Saba',
            'BA' => 'Bosnia and Herzegovina',
            'BW' => 'Botswana',
            'BV' => 'Bouvet Island',
            'BR' => 'Brazil',
            'IO' => 'British Indian Ocean Territory',
            'VG' => 'British Virgin Islands',
            'BN' => 'Brunei',
            'BG' => 'Bulgaria',
            'BF' => 'Burkina Faso',
            'BI' => 'Burundi',
            'KH' => 'Cambodia',
            'CM' => 'Cameroon',
            'CA' => 'Canada',
            'CV' => 'Cape Verde',
            'KY' => 'Cayman Islands',
            'CF' => 'Central African Republic',
            'TD' => 'Chad',
            'CL' => 'Chile',
            'CN' => 'China',
            'CX' => 'Christmas Island',
            'CC' => 'Cocos (Keeling) Islands',
            'CO' => 'Colombia',
            'KM' => 'Comoros',
            'CG' => 'Congo (Brazzaville)',
            'CD' => 'Congo (Kinshasa)',
            'CK' => 'Cook Islands',
            'CR' => 'Costa Rica',
            'HR' => 'Croatia',
            'CU' => 'Cuba',
            'CW' => 'Curaçao',
            'CY' => 'Cyprus',
            'CZ' => 'Czech Republic',
            'DK' => 'Denmark',
            'DJ' => 'Djibouti',
            'DM' => 'Dominica',
            'DO' => 'Dominican Republic',
            'EC' => 'Ecuador',
            'EG' => 'Egypt',
            'SV' => 'El Salvador',
            'GQ' => 'Equatorial Guinea',
            'ER' => 'Eritrea',
            'EE' => 'Estonia',
            'ET' => 'Ethiopia',
            'FK' => 'Falkland Islands',
            'FO' => 'Faroe Islands',
            'FJ' => 'Fiji',
            'FI' => 'Finland',
            'FR' => 'France',
            'GF' => 'French Guiana',
            'PF' => 'French Polynesia',
            'TF' => 'French Southern Territories',
            'GA' => 'Gabon',
            'GM' => 'Gambia',
            'GE' => 'Georgia',
            'DE' => 'Germany',
            'GH' => 'Ghana',
            'GI' => 'Gibraltar',
            'GR' => 'Greece',
            'GL' => 'Greenland',
            'GD' => 'Grenada',
            'GP' => 'Guadeloupe',
            'GU' => 'Guam',
            'GT' => 'Guatemala',
            'GG' => 'Guernsey',
            'GN' => 'Guinea',
            'GW' => 'Guinea-Bissau',
            'GY' => 'Guyana',
            'HT' => 'Haiti',
            'HM' => 'Heard Island and McDonald Islands',
            'HN' => 'Honduras',
            'HK' => 'Hong Kong S.A.R., China',
            'HU' => 'Hungary',
            'IS' => 'Iceland',
            'IN' => 'India',
            'ID' => 'Indonesia',
            'IR' => 'Iran',
            'IQ' => 'Iraq',
            'IE' => 'Ireland',
            'IM' => 'Isle of Man',
            'IL' => 'Israel',
            'IT' => 'Italy',
            'CI' => 'Ivory Coast',
            'JM' => 'Jamaica',
            'JP' => 'Japan',
            'JE' => 'Jersey',
            'JO' => 'Jordan',
            'KZ' => 'Kazakhstan',
            'KE' => 'Kenya',
            'KI' => 'Kiribati',
            'KW' => 'Kuwait',
            'KG' => 'Kyrgyzstan',
            'LA' => 'Laos',
            'LV' => 'Latvia',
            'LB' => 'Lebanon',
            'LS' => 'Lesotho',
            'LR' => 'Liberia',
            'LY' => 'Libya',
            'LI' => 'Liechtenstein',
            'LT' => 'Lithuania',
            'LU' => 'Luxembourg',
            'MO' => 'Macao S.A.R., China',
            'MK' => 'Macedonia',
            'MG' => 'Madagascar',
            'MW' => 'Malawi',
            'MY' => 'Malaysia',
            'MV' => 'Maldives',
            'ML' => 'Mali',
            'MT' => 'Malta',
            'MH' => 'Marshall Islands',
            'MQ' => 'Martinique',
            'MR' => 'Mauritania',
            'MU' => 'Mauritius',
            'YT' => 'Mayotte',
            'MX' => 'Mexico',
            'FM' => 'Micronesia',
            'MD' => 'Moldova',
            'MC' => 'Monaco',
            'MN' => 'Mongolia',
            'ME' => 'Montenegro',
            'MS' => 'Montserrat',
            'MA' => 'Morocco',
            'MZ' => 'Mozambique',
            'MM' => 'Myanmar',
            'NA' => 'Namibia',
            'NR' => 'Nauru',
            'NP' => 'Nepal',
            'NL' => 'Netherlands',
            'AN' => 'Netherlands Antilles',
            'NC' => 'New Caledonia',
            'NZ' => 'New Zealand',
            'NI' => 'Nicaragua',
            'NE' => 'Niger',
            'NG' => 'Nigeria',
            'NU' => 'Niue',
            'NF' => 'Norfolk Island',
            'KP' => 'North Korea',
            'MP' => 'Northern Mariana Islands',
            'NO' => 'Norway',
            'OM' => 'Oman',
            'PK' => 'Pakistan',
            'PW' => 'Palau',
            'PS' => 'Palestinian Territory',
            'PA' => 'Panama',
            'PG' => 'Papua New Guinea',
            'PY' => 'Paraguay',
            'PE' => 'Peru',
            'PH' => 'Philippines',
            'PN' => 'Pitcairn',
            'PL' => 'Poland',
            'PT' => 'Portugal',
            'PR' => 'Puerto Rico',
            'QA' => 'Qatar',
            'RE' => 'Reunion',
            'RO' => 'Romania',
            'RU' => 'Russia',
            'RW' => 'Rwanda',
            'BL' => 'Saint Barthélemy',
            'SH' => 'Saint Helena',
            'KN' => 'Saint Kitts and Nevis',
            'LC' => 'Saint Lucia',
            'MF' => 'Saint Martin (French part)',
            'PM' => 'Saint Pierre and Miquelon',
            'VC' => 'Saint Vincent and the Grenadines',
            'WS' => 'Samoa',
            'SM' => 'San Marino',
            'ST' => 'Sao Tome and Principe',
            'SA' => 'Saudi Arabia',
            'SN' => 'Senegal',
            'RS' => 'Serbia',
            'SC' => 'Seychelles',
            'SL' => 'Sierra Leone',
            'SG' => 'Singapore',
            'SX' => 'Sint Maarten (Dutch part)',
            'SK' => 'Slovakia',
            'SI' => 'Slovenia',
            'SB' => 'Solomon Islands',
            'SO' => 'Somalia',
            'ZA' => 'South Africa',
            'GS' => 'South Georgia and the South Sandwich Islands',
            'KR' => 'South Korea',
            'SS' => 'South Sudan',
            'ES' => 'Spain',
            'LK' => 'Sri Lanka',
            'SD' => 'Sudan',
            'SR' => 'Suriname',
            'SJ' => 'Svalbard and Jan Mayen',
            'SZ' => 'Swaziland',
            'SE' => 'Sweden',
            'CH' => 'Switzerland',
            'SY' => 'Syria',
            'TW' => 'Taiwan',
            'TJ' => 'Tajikistan',
            'TZ' => 'Tanzania',
            'TH' => 'Thailand',
            'TL' => 'Timor-Leste',
            'TG' => 'Togo',
            'TK' => 'Tokelau',
            'TO' => 'Tonga',
            'TT' => 'Trinidad and Tobago',
            'TN' => 'Tunisia',
            'TR' => 'Turkey',
            'TM' => 'Turkmenistan',
            'TC' => 'Turks and Caicos Islands',
            'TV' => 'Tuvalu',
            'VI' => 'U.S. Virgin Islands',
            'UG' => 'Uganda',
            'UA' => 'Ukraine',
            'AE' => 'United Arab Emirates',
            'GB' => 'United Kingdom',
            'US' => 'United States',
            'UM' => 'United States Minor Outlying Islands',
            'UY' => 'Uruguay',
            'UZ' => 'Uzbekistan',
            'VU' => 'Vanuatu',
            'VA' => 'Vatican',
            'VE' => 'Venezuela',
            'VN' => 'Vietnam',
            'WF' => 'Wallis and Futuna',
            'EH' => 'Western Sahara',
            'YE' => 'Yemen',
            'ZM' => 'Zambia',
            'ZW' => 'Zimbabwe'
          )
        );
        $form['form_title'] = array(
          '#weight' => -1000,
          '#markup' => '<h2>' . t('About you') . '</h2>'
        );
        break;
      case 'hosting_signup_form':
        $form['#attached']['css'][] = drupal_get_path('module', 'hosting_scratchpads') . '/css/hosting_scratchpads.css';
        $form['#attached']['js'][] = drupal_get_path('module', 'beautytips') . '/js/jquery.bt.min.js';
        $form['#attached']['js'][] = drupal_get_path('module', 'beautytips') . '/js/beautytips.min.js';
        $form['#prefix'] = '<div class="scratchpads-hosting-form">';
        $form['#suffix'] = '</div>';
        break;
    }
  }
}